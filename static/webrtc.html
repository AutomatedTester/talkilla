<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC test</title>
  <style>
  table {width: 100%;}
  video {width: 100%; height: 150px; background: #ccc;}
  textarea {display: block; width: 100%; height: 200px;}
  form input {width: 100%;}
  button[type="submit"] {display: none;}
  </style>
</head>
<body>

  <button id="start">Start</button>
  <button id="stop">Stop</button>

  <table>
    <tr>
      <th>Local</th>
      <th>Remote</th>
    </tr>
    <tr>
      <td>
        <video id="local"></video>
        <form id="local-chat">
          <input><button type="submit"></button>
        </form>
        <textarea id="local-chat-log"></textarea>
        <textarea id="local-log"></textarea>
      </td>
      <td>
        <video id="remote"></video>
        <form id="remote-chat">
          <input><button type="submit"></button>
        </form>
        <textarea id="remote-chat-log"></textarea>
        <textarea id="remote-log"></textarea>
      </td>
    </tr>
  </table>

  <script src="vendor/jquery-1.9.1.js"></script>
  <script src="vendor/underscore-1.4.4.js"></script>
  <script src="vendor/backbone-1.0.0.js"></script>
  <script src="vendor/state-machine-2.2.0.js"></script>
  <script src="js/webrtc.js"></script>

  <script>
    // test
    var local = document.getElementById('local');
    var remote = document.getElementById('remote');
    var localChat = document.getElementById('local-chat');
    var localChatLog = document.getElementById('local-chat-log');
    var localLog = document.getElementById('local-log');
    var remote = document.getElementById('remote');
    var remoteChat = document.getElementById('remote-chat');
    var remoteChatLog = document.getElementById('remote-chat-log');
    var remoteLog = document.getElementById('remote-log');
    var startBt = document.getElementById('start');
    var stopBt = document.getElementById('stop');

    var offerer = new WebRTC(new mozRTCPeerConnection());
    var answerer = new WebRTC(new mozRTCPeerConnection());

    function log(el) {
      el.value += [].slice.call(arguments, 1).join(' ') + "\n";
    }

    offerer.log = log.bind(offerer, localLog);
    answerer.log = log.bind(offerer, remoteLog);

    function send(form, event) {
      event.preventDefault();
      this.send(form.querySelector('input').value);
    }

    localChat.addEventListener('submit', send.bind(offerer, localChat));
    remoteChat.addEventListener('submit', send.bind(answerer, remoteChat));

    function logChat(el, event) {
      el.value += event.data + "\n";
    }

    offerer.logChat = log.bind(offerer, localChatLog);
    answerer.logChat = log.bind(offerer, remoteChatLog);

    startBt.addEventListener('click', start);
    stopBt.addEventListener('click', stop);

    function start() {
      offerer.on('all', function() {
        this.log.apply(this, arguments);
      });

      answerer.on('all', function() {
        this.log.apply(this, arguments);
      });

      offerer.on('offer-ready', function(offer) {
        answerer.answer(offer).on('answer-ready', function(answer) {
          offerer.establish(answer);
        });
      });

      offerer.on('dc:open', function() {
        this.send('hi');
      });

      offerer.on('dc:message-in', function(event) {
        this.logChat(event.data);
      });

      answerer.on('dc:message-in', function(event) {
        this.logChat(event.data);
      });

      offerer.on('connection-terminated', function() {
        local.mozSrcObject = null;
      });

      answerer.on('connection-terminated', function() {
        remote.mozSrcObject = null;
      });

      offerer.on('local-stream-ready', function(stream) {
        local.mozSrcObject = stream;
        local.play();
      });

      offerer.on('remote-stream-ready', function(stream) {
        remote.mozSrcObject = stream;
        remote.play();
      });

      offerer.initiate({video: true, audio: true});
    }

    function stop() {
      offerer.terminate();
      answerer.terminate();
    }
  </script>
</body>
</html>
